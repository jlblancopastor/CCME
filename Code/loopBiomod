#### BIOMOD LOOP FOR EVERY SPECIES IN THE DATASET ####
#### 0. PREPARATORY PROCEDURES ####

packages<-c("raster", "biomod2", "dismo","mgcv","rasterVis","RColorBrewer","rgdal","mgcv","shapefiles","rgeos","sp","maptools", "maps")
lapply(packages, require, character.only=T)
geoproj<-"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
species.list<.list.files(pattern="\\.shp$") #a list containing the names of the species written exactly as in the qgis folder where all shapefiles are stored

presence.absence.raster <- function (mask.raster,species.data,raster.label="") {
mask.raster[!is.na(mask.raster)] <- 0
speciesRaster <- rasterize(species.data,mask.raster,field=1)
speciesRaster <- merge(speciesRaster,mask.raster)
names(speciesRaster) <- raster.label
return(speciesRaster)
}
#### 1. BIOMOD PARAMETERS ####
#this is set up, for now, in a separate branch
#### 2. LOOP ####
#species.list shall be created directly with a search string with regmatches()
for (s in species.list) {
  setwd("") # where the shapefiles are. Currently for this is in "F:/Climatechange/Qgis"
  shape.species<-readShapePoints(s,proj4string = CRS(geoproj)) #creates a shapefile of points for the ith species
  shape.mountain<-readShapePoly("mountains",proj4string = CRS(geoproj)) #reads the global mountain polygon shapefile
  select.mountain<-over(shape.species,shape.mountain)  #overlays species ocurrences with  
  select.mountain<-as.data.frame(droplevels(select.mountain$Name)) #erase non-used levels
  names.mountain<-levels(select.mountain[,1]) #selects the names of the mountain ranges
  
  #### 2.1 Begin reading shapefiles and preparing stack of predictors
  variable.list<-c("prec","tmin","tmax")
  initial.months<-c("1","2","3","4","5","6","7","8","9","10","11","12")
  final.months<-c("01","02","03","04","05","06","07","08","09","10","11","12")
  selected.shape.mountain<-shape.mountain[shape.mountain$Name %in% names.mountain,] #subsets the polygons with species occurrences
    unzip("tmax01.zip") #original download names of CHELSA variables should be replaced
    message(paste("masking tmax01 for",i,sep=" "),appendLF=T)
    tmax01<-mask(crop(raster("CHELSA_tmax_1_1979-2013_land.tif",crs=geoproj),selected.shape.mountain),selected.shape.mountain)
    file.remove("CHELSA_tmax_1_1979-2013_land.tif")
    ### etc.
   
    }
    
  #### 2.2 BIOMOD MODELLING #### MODEL CALIBRATION
  
       #2.2.1 Calibration dataset
  
}
