#### BIOMOD LOOP FOR EVERY SPECIES IN THE DATASET ####
#### 0. PREPARATORY PROCEDURES ####

packages<-c("raster", "biomod2", "dismo","mgcv","rasterVis","RColorBrewer","rgdal","mgcv","shapefiles","rgeos","sp","maptools", "maps", "ecospat")
lapply(packages, require, character.only=T)
geoproj<-"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
species.list<.list.files(pattern="\\.shp$") #a list containing the names of the species written exactly as in the qgis folder where all shapefiles are stored

presence.absence.raster <- function (mask.raster,species.data,raster.label="") {
mask.raster[!is.na(mask.raster)] <- 0
speciesRaster <- rasterize(species.data,mask.raster,field=1)
speciesRaster <- merge(speciesRaster,mask.raster)
names(speciesRaster) <- raster.label
return(speciesRaster)
}
#### 1. BIOMOD PARAMETERS ####
#this is set up, for now, in a separate branch
#### 2. LOOP ###
setwd("") # where the shapefiles are. Currently for this is in "F:/Climatechange/Qgis"
species.list<-list.files(pattern="\\.shp$")
gsub(".pdf",replacement="",list)
for (s in species.list) {
  
  shape.species<-readShapePoints(s,proj4string = CRS(geoproj)) #creates a shapefile of points for the sth species
  shape.mountain<-readShapePoly("mountains",proj4string = CRS(geoproj)) #reads the global mountain polygon shapefile
  select.mountain<-over(shape.species,shape.mountain)  #overlays species ocurrences with species distribution 
  select.mountain<-as.data.frame(droplevels(select.mountain$Name)) #erase non-used levels
  names.mountain<-levels(select.mountain[,1]) #selects the names of the mountain ranges
  #### 2.1 #### MODELING FOR PRESENT
  #Bioclimatic variables are downloaded
  setwd().. #where the bioclimatic variables for CHELSA are (only the 13-15 that are selected).
  unzip(dir())
  variable.list <- Sys.glob("*.tif$")
    predictors <- stack()
    for(i in 1:nrow(variable.list)){
    tempraster <- mask(crop(raster(predictors[i]),selected.shape.mountain),selected.shape.mountain)
    predictors <- stack(predictors,tempraster)
      }
   species.coords<-coords(s)
  test.presence<-extract(predictors,species.coords)
  corvar <- cor(test.presence, method="pearson")
  nvars<- ecospat.npred (corvar, th=0.75)
  test.absence<-
  test.absence<-extract(predictors,species.coords)
        #2.1.1 Calibration dataset
       
        species<-s
        species.map<-as.data.frame(presence.absence.raster(bio01,species.coords,raster.label=species),xy=TRUE) # check if bio01 is one of the biovars to use as mask
        species.na<-species.map[,3]
        species.na[species.na==0]="NA"
        species.na<-cbind(species[,1:2],species.na)
        colnames(species.na)<-c("x","y",s)
        
      myRespName <- s
# the presence/absences data for our species
myResp <- as.numeric(species.na[,myRespName])
myResp[myResp == 2]  <- "NA"
myResp<-as.numeric(myResp)
# the XY coordinates of species data
myRespXY <- species.na[,c("x","y")]


        data<-BIOMOD_FormatingData(resp.var=myResp,
                            expl.var=predictors,
                            resp.xy = myRespXY,
                            resp.name = myRespName,
                            eval.resp.var = NULL,
                            eval.expl.var = NULL,
                            eval.resp.xy = NULL,
                            PA.nb.rep = 5,
                            PA.nb.absences = nrow(species.coords)*6, #this is the minimal number which is optimal for me
                            PA.strategy = 'random',
                            na.rm = TRUE)
        # rasters or any supported format by the raster package)
        rm() #remove the predictors used here

#### 5.2 MODELING ####
models <- BIOMOD_Modeling(
  data,
  models = c('GBM','RF',"GLM","GAM","MARS","ANN"), #GAM is going to be trickier for species with a scarce number of points
  #models.options = myBiomodOption, #check the script which has been set aside in github
  NbRunEval=5,
  DataSplit=90,
  VarImport=1,
  prevalence=0.5,
  models.eval.meth = c("ROC",'TSS'),
  SaveObj = FALSE,
  rescal.all.models = FALSE,
  do.full.models = FALSE,
  modeling.id = paste(myRespName,"FirstModeling",sep=""))

  rm(data)

proj.models<-BIOMOD_Projection(models,
              new.env=predictors,
              proj.name=s,
              xy.new.env = NULL,
              selected.models = 'all',
              binary.meth = "TSS",
              filtered.meth = "TSS","ROC",
              compress = TRUE,
              build.clamping.mask = FALSE)

rm(predictors)

models.ensemble.mean.weight<- BIOMOD_EnsembleModeling( models,
                                            chosen.models = 'all',
                                            em.by = 'all',
                                            eval.metric = 'all',
                                            eval.metric.quality.threshold = c(0.8,0.8),
                                            models.eval.meth = c("ROC",'TSS'),
                                            prob.mean = FALSE,
                                            prob.cv = FALSE,
                                            prob.ci = FALSE,
                                            prob.ci.alpha = 0.05,
                                            prob.median = FALSE,
                                            committee.averaging = FALSE,
                                            prob.mean.weight = TRUE,
                                            prob.mean.weight.decay = 'proportional',
                                             VarImport = 1)
ensemble.pres.mean.weight<-BIOMOD_EnsembleForecasting( models.ensemble.mean.weight,
                                           projection.output = proj.models,
                                           selected.models = 'all',
                                           binary.meth = "TSS",
                                           filtered.meth = c("ROC",'TSS'),
                                           total.consensus=TRUE,
                                           compress = TRUE)
prediction.present<-paste(""ensemble.pres.mean.weight@proj@val$",s,"_EMwmeanByTSS_mergedAlgo_mergedRun_mergedData) #check if this works
writeRaster(prediction.present,paste(s,".pres.asc",sep="")) ###threshold techniques to define

  #### 2.2 #### FUTURE MODELING
  models<-c("csiro","miroc")
  rcps<-c(26,60,85)
  years<-c(30,50,80)
  for (m in models){
  for (r in rcps){
  for (y in years){
  #### 2.2 For each climate scenario, begin reading shapefiles and preparing stack of predictors
    setwd(paste(XXXX,m,r,y)) #go to the folder were bioclimatic variables for the future are
    predictors <- stack()
      for(i in 1:NROW(variable.list)){
      tempraster <- mask(crop(raster(predictors[i]),selected.shape.mountain),selected.shape.mountain)
      predictors <- stack(predictors,tempraster)
      }
      models.ensemble.mean.weight<- BIOMOD_EnsembleModeling( models,
                                            chosen.models = 'all',
                                            em.by = 'all',
                                            eval.metric = 'all',
                                            eval.metric.quality.threshold = c(0.8,0.8),
                                            models.eval.meth = c("ROC",'TSS'),
                                            prob.mean = FALSE,
                                            prob.cv = FALSE,
                                            prob.ci = FALSE,
                                            prob.ci.alpha = 0.05,
                                            prob.median = FALSE,
                                            committee.averaging = FALSE,
                                            prob.mean.weight = TRUE,
                                            prob.mean.weight.decay = 'proportional',
                                             VarImport = 1)
      ensemble.mean.weight<-BIOMOD_EnsembleForecasting( models.ensemble.mean.weight,
                                           projection.output = proj.models,
                                           selected.models = 'all',
                                           binary.meth = "TSS",
                                           filtered.meth = c("ROC",'TSS'),
                                           total.consensus=TRUE,
                                           compress = TRUE)
      prediction.present<-paste("ensemble.mean.weight@proj@val$",s,"_EMwmeanByTSS_mergedAlgo_mergedRun_mergedData") #check if this works
      writeRaster(prediction.present,paste(s,m,r,y,".pres.asc",sep=""))
    }#close temporal horizon loop
    }# close rcps loop
    }#close general circulation models loop
    } #close all the loop
    
    
  
 
